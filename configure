#!/bin/bash

user=`whoami`
group=`groups | cut -d' ' -f1`

read -r -d '' makefile <<EOF
all: beat monitor

beat:
	gcc -O3 src/beat.c -o beat

libs/cJSON.o:
	gcc -O3 -c libs/cJSON.c -o libs/cJSON.o

src/argparse.o:
	gcc -O3 -c src/argparse.c -o src/argparse.o

src/telegram.o:
	gcc -O3 -c src/telegram.c -o src/telegram.o

monitor: libs/cJSON.o src/telegram.o src/argparse.o
	gcc -O3 libs/cJSON.o src/telegram.o src/argparse.o src/monitor.c -lcurl -levent -o monitor

test/argparse:
	gcc -g -c src/argparse.c -o src/argparse.o
	gcc -g src/argparse.o test/argparse.c -o test/argparse

tests: test/argparse

cleantests:
	-@rm src/argparse.o 2>/dev/null
	-@rm test/argparse 2>/dev/null

clean: cleantests
	-@rm beat 2>/dev/null
	-@rm monitor 2>/dev/null
	-@rm libs/*.o 2>/dev/null
	-@rm src/*.o 2>/dev/null
	-@rm beat.service 2>/dev/null
	-@rm Makefile 2>/dev/null

install_dirs:
	sudo mkdir -p /var/hearthbeat
	sudo chown $user:$group /var/hearthbeat
	sudo mkdir -p /etc/hearthbeat
	sudo chown $user:$group /etc/hearthbeat

install_beat: install_dirs
	sudo mv beat /usr/local/bin/beat
	sudo mv beat.service /etc/systemd/system/beat.service

install_monitor:
	sudo mv monitor /usr/local/bin/monitor
	sudo mv monitor.service /etc/systemd/system/monitor.service

install: install_beat install_monitor

uninstall:
	sudo rm /usr/local/bin/beat
	sudo rm /usr/local/bin/monitor
	sudo rm /etc/systemd/system/beat.service
	sudo rm /etc/systemd/system/monitor.service
	sudo rm -rf /var/hearthbeat
	sudo rm -rf /etc/hearthbeat
EOF

read -r -d '' unitfile <<EOF
[Unit]
Description=Very simple heartbeat service

[Service]
User=$user
Group=$user
Type=forking
PIDFile=/var/hearthbeat/pid
ExecStart=/usr/local/bin/beat
Restart=always

[Install]
WantedBy=multi-user.target
EOF

read -r -d '' monitorunitfile <<EOF
[Unit]
Description=Very simple monitor service

[Service]
User=$user
Group=$user
Type=simple
ExecStart=/usr/local/bin/monitor
Restart=always

[Install]
WantedBy=multi-user.target
EOF

echo "$makefile" > Makefile
echo "$unitfile" > beat.service
echo "$monitorunitfile" > monitor.service